# 内存区域划分

## 程序计数器

一块较小的内存空间，是当前线程执行的字节码的行号指示器。字节码解释器通过改变计数器的值选取下一条需要执行的字节码指令。每个线程都有一个独立的程序计数器。

如果线程执行的是 `Java` 方法，计数器记录的是正在执行的虚拟机字节码指令的地址；如果线程执行的是 `Native`
方法，计数器值应为空。该区域是唯一没有规定 `OutOfMemoryError` 情况的区域。

## 虚拟机栈

线程私有，生命周期和线程相同。描述的是 `Java`
方法执行的线程内存模型，每个方法被执行，虚拟机会创建一个栈帧，存储局部变量表、操作数栈、动态连接、方法出口等。每个方法被调用到执行完毕，对应一个栈帧从入栈到出栈的过程。

局部变量表存放了编译期可知的基本数据类型、对象引用，64位的 `long` 和 `double` 会占用两个 `slot`
，其余只占一个。局部变量表所需的内存空间在编译期完成分配，进入方法时，该方法需要在栈帧中分配的空间时完全确定的。

如果线程请求栈深度大于虚拟机允许的深度，抛出 `StackOverflowError`
；如果虚拟机容量可动态扩展，当栈扩展时无法申请到足够内存会抛出 `OutOfMemoryError`。

## 本地方法栈

和虚拟机栈的区别是，本地方法栈为 `Native` 方法服务。

## 堆

堆是虚拟机管理的最大的一块内存，是所有线程共享的内存区域，虚拟机启动时创建。唯一目的就是存放对象实例，是垃圾收集器管理的内存区域。堆可划分出多个线程私有的分配缓冲区，以提升对象分配时的效率。堆可分配在不连续的物理内存中，逻辑上应是连续的，对于大对象，可能会要求连续的内存空间。

## 方法区

存储虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存。JDK8后，用在本地内存中实现的元空间实现方法区。该区域的内存回收目标主要针对常量池的回收和对类型的卸载。

运行时常量池是方法区的一部分。`Class` 文件除了有类版本、字段、方法、接口等描述信息外，还有一项是常量池表，存放编译期生成的字面量和符号引用，这部分在类加载后放到运行时常量池。运行时常量池具备动态性，运行期间生成的新常量也可以放入池中。

# 对象创建

创建对象使用 `new` 指令，虚拟机遇到 `new` 指令时，先检查该指令的参数能否在常量池定位到该类的符号引用，检查该符号引用代表的类是否被加载、解析、初始化过，如果没有，先加载该类。类加载检查后，为新生对象分配内存。对象所需内存大小在类加载完成即可确定，为对象分配空间会将一块确定大小的内存块从堆中划分出来。

分配方式：

- 指针碰撞：若堆内存是规整的，有一个指针作为已分配区域和空闲区域的分界点，将指针挪动与对象大小相同的距离。
- 空闲列表：若堆内存不规整，虚拟机维护一个列表，记录每个内存块的状态，找出一块足够大的内存分配给对象，更新列表。

