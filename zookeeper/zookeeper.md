# 分布式理论

`CAP` 原理，分布式系统三个基本需求最多只能同时满足两个。一致性，数据在多副本间保持一致。可用性，服务一直可用。分区容错性，分区损坏或有网络故障，仍能保证一致性和可用性。由于网络和机器总有出现故障的时候，三个需求只能同时满足两个。分区容错性又是必须要满足的，只能满足 `CP` 或 `AP`。`CP` 保证强一致性，会导致延迟，事务数据库一般采用该模式。`AP` 保证可用性，不能时刻保持一致性，但会保证最终一致性，`NoSQL` 一般采用该模式。

`BASE`：基本可用，系统出现故障，允许损失部分可用性，如响应时间上的损失。软状态，允许不同分区数据不一致，这个不一致只是中间状态。最终一致性，保证在一定时间内各分区副本达到一致性。

事务需要保证 `ACID`，若操作的资源在不同节点上，需要分布式事务。

二阶段提交，需要一个协调者管理各节点的事务状态。阶段一，协调者向各节点发送消息，各节点执行事务将结果反馈给协调者。阶段二，若所有节点执行成功，协调者向各节点发送提交命令，否则发送回滚命令。问题：单点故障，要等待所有节点，阻塞时间太长。

三阶段提交，减少二阶段提交的阻塞时间。阶段一，先询问各节点能否执行事务。阶段二，发送事务执行命令。阶段三，根据执行结果决定是提交还是回滚事务。仍然存在单点故障，只是减少了一定的阻塞时间，实现起来更复杂。

`Paxos` ，分布式一致性算法。目标：快速将某个值在集群内部达成一致。三个角色：`Proposer`，提出一个值版本。`Acceptor`，接受一个版本的值。`Leaner`，接受 `Acceptor` 的值。`Proposer` 提出的值带一个版本号，发送到每个 `Acceptor`；`Acceptor` 必须接受收到的一个版本，后续能接受比当前版本更大的值。为尽快让该值在集群内达成一致，`Proposer` 收到 `Acceptor`，会将值改成比自己版本更大的值。当有半数以上的 `Acceptor` 接受该值，投票结束。工程上不易实现，确定了分布式一致性算法的基本思路。

`ZAB` 协议，包括原子广播和崩溃恢复。首先选举一个 `Leader`，`Leader` 接受事务后同步给 `Follower`，有半数以上 `Follower` 正确响应，则提交事务。崩溃恢复，`Leader` 崩溃后从 `Follower` 中重新选举，保证服务始终可用。主要用于 `Zookeeper`。

`Raft` 协议，本质也是依赖 `Leader` 实现数据一致性。有 `term` 的概念，一个 `term` 是一个 `Leader` 周期。每过一个 `term`，所有节点会尝试竞选 `Leader`，`Leader` 需要时刻发送心跳阻止 `Follower` 精选。`Leader` 同步日志到各个 `Follower`，根据回应个数决定是否提交。和 `ZAB` 的区别是，提交的日志不可撤回，`ZAB` 为保证数据一致性，会放弃部分未提交的事务。

# Zookeeper

角色：`Leader` 和 `Follower`。只有 `Leader` 支持写请求，其他节点收到写请求会转发给 `Leader`。因用的是树状结构存储，需要有序执行写操作。`Leader` 为写请求分配一个全局递增的 `zxid`，转发给 `Follower`。`Follower` 先记录日志到本地，响应 `Leader`，若 `Leader` 收到半数以上的回应，提交事务。

为避免阻塞，`Leader` 和 `Follower` 通过队列通信，`FIFO` 保证有序执行。提升性能，可以从每个 `Follower`，可能读到还未同步的节点。若要保证强一致性，只从 `Leader` 读。

崩溃恢复，若 `Leader` 挂了，从 `Follower` 选出新的 `Leader`。候选 `Follower` 要保证没有未提交的事务，`zxid` 最大。新 `Leader` 选出后，将 `zxid` 同步给 `Follower`，`Follower` 根据自身的事务更新。`zxid` 有64位，前32位是事务的自增 `id`，后32位表示一个 `Leader` 周期。`Leader` 会周期发送心跳给 `Follower` 保持连接，若 `Follower` 长时间未收到 `Leader` 心跳，触发选举。

若 `Follower` 无法连接 `Leader`，会变为 `Looking` 状态，暂停提供查询请求。

数据模型：树形结构存储，基本单元是 `ZNode`，以 `key` / `value` 形式保存。临时节点会话关闭就会消失，不能有子节点，适用于心跳、服务发现。永久节点一直存在，可以有子节点。顺序节点创建时名称会加上自增ID，表示创建顺序。临时顺序节点可用于分布式锁，序号最小的节点先获得锁，有比自己序号更小的锁则等待。永久顺序节点可实现分布式队列。

维护了 `ACL` 列表控制对 `ZNode` 的访问，可指定 `IP` 端口、账号密码。

`Watcher` 机制，实现发布订阅。客户端注册 `Watcher` 到服务端，监听指定 `ZNode` 的事件，包括 `Add`、`Delete`、`Update`。若事件发生，服务端通知客户端执行相应的操作。只是一次性的，`Watcher` 触发后会被删除，继续使用需要再次注册。
