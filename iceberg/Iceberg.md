存储：存储数据的系统，HDFS或S3。文件格式：数据存储组织形式，JSON或CSV。表格式：充当文件格式之上的元数据层，指定数据文件在存储中的布局方式。存储引擎：实际执行按照表格式指定的形式布置数据的系统，使所有文件和数据结构与新数据保持同步的系统，执行物理优化、索引维护及清理数据。目录：利用元数据识别数据集。

数仓的局限，主要支持结构化数据，锁定了存储引擎。若需要用于ML，需要重新导入数据，易产生数据漂移、模型衰减等问题。

数据湖和数仓的重要区别：能用不同的计算引擎处理不同的工作负载。数据湖定义一个表是什么数据，可指向不同的文件。

Hive表定义是基于目录而不是单个数据文件。现代表格式将表定义为文件，为引擎提供元数据，告知哪些文件组成表，而不是哪些目录。

更新表的多个分区，用户不应该体验到查看的数据不一致，表跨多个分区的更新应该是快速原子的。

# **Hive表的缺陷**

Hive表格式只保存了数据文件目录，文件切分前要使用list操作列出所有文件。频繁大量调用list会给NameNode带来巨大的RPC压力，文件数过多会很耗时。Executor执行先把计算结果写入临时目录，待Executor全部执行完，Driver把临时目录rename到正式目录。

list和rename在对象存储上都很耗时，难以用对象存储替代HDFS。schema存储在metastore，容易成为性能瓶颈。

# **iceberg表分层**

数据层存储表的实际数据，由数据文件本身组成，包含删除文件。提供用户查询所需数据，一些例外情况元数据层可提供结果。通常由对象存储、HDFS支持。数据湖存储视为不可变，无法直接更新文件中的行，要编写一个新文件，作为旧文件的副本，更改体现在新副本上。读取文件时将更改合并。

元数据层包含表的所有元数据文件，树状结构，跟踪数据文件及其元数据以及导致它们创建的操作。包含清单文件、清单列表和元数据文件。清单文件跟踪数据层中的数据文件和删除文件，实现文件级别跟踪表中的数据，每个清单文件跟踪一部分数据文件。

